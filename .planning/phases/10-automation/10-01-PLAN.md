---
phase: 10-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/daily-collection.yml
  - main.py
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "A GitHub Actions workflow triggers the pipeline daily at 06:30 UTC (noon IST) on a cron schedule"
    - "The pipeline step has a 45-minute timeout; the overall job has a 50-minute timeout"
    - "The workflow also supports manual trigger via workflow_dispatch"
    - "API keys are passed from GitHub Secrets as environment variables; missing secrets degrade to None (not empty string)"
    - "After pipeline completion, output files are force-added (bypassing .gitignore) and committed+pushed if changed"
    - "If no new data was collected, the workflow exits cleanly without creating an empty commit"
    - "If the pipeline is killed by timeout, the checkpoint file persists for the next run to resume"
  artifacts:
    - path: ".github/workflows/daily-collection.yml"
      provides: "Complete GitHub Actions workflow for daily automated collection"
      contains: "cron: '30 6 * * *'"
    - path: "main.py"
      provides: "Pipeline entry point with empty-string secret handling"
      contains: "or None"
    - path: ".gitignore"
      provides: "Gitignore with CI override comment"
      contains: "/output/"
  key_links:
    - from: ".github/workflows/daily-collection.yml"
      to: "main.py"
      via: "run: python main.py"
      pattern: "python main\\.py"
    - from: ".github/workflows/daily-collection.yml"
      to: "GitHub Secrets"
      via: "secrets.NEWSDATA_API_KEY and secrets.GNEWS_API_KEY env vars"
      pattern: "secrets\\."
    - from: ".github/workflows/daily-collection.yml"
      to: "output/"
      via: "git add --force output/"
      pattern: "git add --force output/"
    - from: "main.py"
      to: "src/sources"
      via: "os.environ.get(KEY) or None passed to source constructors"
      pattern: "or None"
---

<objective>
Create the GitHub Actions workflow that runs the heat news extraction pipeline daily, and fix the empty-string secret handling in main.py so API keys degrade gracefully in CI.

Purpose: This is the final phase -- turning a locally-runnable pipeline into a fully automated daily collection system. The workflow handles scheduling, dependency installation, pipeline execution with timeout, and auto-commit of results.

Output: A working `.github/workflows/daily-collection.yml` and a one-line fix in `main.py` for CI compatibility.
</objective>

<execution_context>
@/Users/akashyadav/.claude/get-shit-done/workflows/execute-plan.md
@/Users/akashyadav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-automation/10-RESEARCH.md
@main.py
@.gitignore
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions daily collection workflow</name>
  <files>.github/workflows/daily-collection.yml</files>
  <action>
Create `.github/workflows/daily-collection.yml` with the following exact configuration:

**Triggers:**
- `schedule` with cron `'30 6 * * *'` (comment: 12:00 noon IST)
- `workflow_dispatch` for manual trigger from Actions tab

**Permissions:**
- `contents: write` (required for git push with GITHUB_TOKEN)

**Job `collect`:**
- `runs-on: ubuntu-latest`
- `timeout-minutes: 50` (job-level: 45 pipeline + 5 buffer for setup/commit)

**Steps (in order):**

1. `actions/checkout@v6` -- clone repository

2. `actions/setup-python@v6` with `python-version: '3.12'` and `cache: 'pip'` -- install Python with pip caching from requirements.txt hash

3. "Install dependencies" -- `pip install -r requirements.txt`

4. "Run collection pipeline" with:
   - `timeout-minutes: 45` (step-level timeout for the pipeline itself)
   - `env` block mapping `NEWSDATA_API_KEY: ${{ secrets.NEWSDATA_API_KEY }}` and `GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}`
   - `run: python main.py`

5. "Commit and push results" with multi-line run block:
   - `git config user.name "github-actions[bot]"`
   - `git config user.email "41898282+github-actions[bot]@users.noreply.github.com"`
   - `git add --force output/` (force bypasses .gitignore)
   - `if git diff --cached --quiet; then echo "No new data to commit"; else git commit -m "data: daily collection $(date -u +%Y-%m-%d)" && git push; fi`

Use the standard bot email `41898282+github-actions[bot]@users.noreply.github.com` (not a custom email).
Do NOT use any third-party commit actions -- manual git commands for full control.
Do NOT use `git add .` or `git add -A` -- only `git add --force output/`.
Do NOT use `--allow-empty` on commit.
  </action>
  <verify>
Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/daily-collection.yml'))"`

If PyYAML is not installed, use: `python -c "import json, re; content=open('.github/workflows/daily-collection.yml').read(); assert 'cron:' in content; assert 'workflow_dispatch' in content; assert 'timeout-minutes: 45' in content; assert 'git add --force output/' in content; assert 'git diff --cached --quiet' in content; assert 'actions/checkout@v6' in content; assert 'actions/setup-python@v6' in content; assert 'secrets.NEWSDATA_API_KEY' in content; assert 'secrets.GNEWS_API_KEY' in content; assert 'contents: write' in content; print('All assertions passed')"`
  </verify>
  <done>
`.github/workflows/daily-collection.yml` exists with: dual triggers (cron + manual), 45-min step timeout, 50-min job timeout, Python 3.12 with pip cache, both API key secrets as env vars, and conditional commit+push of force-added output files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix empty-string secret handling and document .gitignore CI override</name>
  <files>main.py, .gitignore</files>
  <action>
**In main.py** (lines 58-59), change the API key retrieval from:
```python
newsdata_key = os.environ.get("NEWSDATA_API_KEY")
gnews_key = os.environ.get("GNEWS_API_KEY")
```
To:
```python
newsdata_key = os.environ.get("NEWSDATA_API_KEY") or None
gnews_key = os.environ.get("GNEWS_API_KEY") or None
```

This handles the GitHub Actions behavior where undefined secrets resolve to empty string `""` rather than being absent from the environment. The `or None` converts `""` (falsy) to `None`, which the source constructors already handle by disabling the source.

Do NOT change anything else in main.py. The rest of the file is correct.

**In .gitignore**, add a comment above the `/output/` line explaining the CI override:
```
# Output directory -- ignored locally, force-added by CI workflow
/output/
```

Do NOT remove `/output/` from .gitignore. The `git add --force` in the workflow handles this.
  </action>
  <verify>
Verify the `or None` pattern: `python -c "from main import *; print('main.py imports cleanly')"`

Verify .gitignore still has /output/: `grep '/output/' .gitignore`

Verify or None in main.py: `grep 'or None' main.py`
  </verify>
  <done>
`main.py` converts empty-string env vars to None for both API keys. `.gitignore` documents the CI override for `/output/`.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/daily-collection.yml` exists and contains valid YAML with all required fields
2. `main.py` uses `or None` pattern for both `NEWSDATA_API_KEY` and `GNEWS_API_KEY`
3. `.gitignore` still contains `/output/` with an explanatory comment
4. No other files were modified
5. The workflow references `python main.py` which is the existing entry point
6. The workflow uses `actions/checkout@v6` and `actions/setup-python@v6` (latest versions per research)
</verification>

<success_criteria>
- AUTO-01: GitHub Actions triggers daily on cron schedule -- SATISFIED by `cron: '30 6 * * *'` in workflow
- AUTO-02: Full run within 45 minutes -- SATISFIED by `timeout-minutes: 45` on pipeline step + existing checkpoint/resume for graceful degradation
- AUTO-03: Zero API budget -- SATISFIED by secrets being optional (pipeline runs with Google News RSS alone if no keys configured)
- AUTO-04: Commits and pushes data files -- SATISFIED by `git add --force output/` and conditional commit+push
- Interrupted runs resume -- SATISFIED by existing checkpoint system (step timeout kills process, checkpoint file persists in output dir, next run loads it)
</success_criteria>

<output>
After completion, create `.planning/phases/10-automation/10-01-SUMMARY.md`
</output>
