---
phase: 05-secondary-news-sources
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/sources/gnews.py
  - src/sources/__init__.py
autonomous: true
user_setup:
  - service: gnews.io
    why: "Tertiary news source for heat article collection"
    env_vars:
      - name: GNEWS_API_KEY
        source: "Sign up at https://gnews.io/register -> Dashboard -> API Key"

must_haves:
  truths:
    - "GNewsSource.search() returns list[ArticleRef] from GNews API"
    - "When GNEWS_API_KEY is missing, GNewsSource returns empty results without crashing"
    - "When daily quota (100 requests) is exhausted, search() returns empty list immediately without making HTTP request"
    - "HTTP 403 (quota exhausted) is detected and stops further requests for the run"
    - "Unsupported languages (gu, kn, or, as, ur, ne) return empty list without making HTTP request"
  artifacts:
    - path: "src/sources/gnews.py"
      provides: "GNewsSource class implementing NewsSource Protocol"
      contains: "class GNewsSource"
    - path: "src/sources/__init__.py"
      provides: "Package re-export of all four source symbols"
      contains: "GNewsSource"
  key_links:
    - from: "src/sources/gnews.py"
      to: "https://gnews.io/api/v4/search"
      via: "httpx.AsyncClient.get() with apikey query param"
      pattern: "gnews\\.io/api/v4/search"
    - from: "src/sources/gnews.py"
      to: "src/models/article.py"
      via: "ArticleRef construction from JSON response"
      pattern: "ArticleRef\\("
---

<objective>
Implement the GNews source adapter that satisfies the NewsSource Protocol and returns ArticleRef objects from the GNews REST API.

Purpose: COLL-06 requires GNews as a tertiary news source (~100 queries/day). This adapter mirrors the existing GoogleNewsSource pattern but queries the gnews.io JSON API. GNews supports fewer Indian languages (8 of 14) so unsupported languages must be filtered before making requests.
Output: `src/sources/gnews.py` with GNewsSource class, updated `src/sources/__init__.py` with all four re-exports.
</objective>

<execution_context>
@/Users/akashyadav/.claude/get-shit-done/workflows/execute-plan.md
@/Users/akashyadav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-secondary-news-sources/05-RESEARCH.md
@.planning/phases/05-secondary-news-sources/05-01-SUMMARY.md
@src/sources/_protocol.py
@src/sources/google_news.py
@src/sources/newsdata.py
@src/sources/__init__.py
@src/models/article.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GNewsSource adapter</name>
  <files>src/sources/gnews.py</files>
  <action>
Create `src/sources/gnews.py` implementing `GNewsSource` that satisfies the `NewsSource` Protocol.

Mirror the `GoogleNewsSource` and `NewsDataSource` class structure:

1. **Constructor** accepting `api_key: str | None = None`, `client: httpx.AsyncClient | None = None`, `timeout: float = 15.0`:
   - Store `_api_key`, `_client`, `_owns_client = client is None`, `_timeout`
   - Add `_daily_count: int = 0` and `_daily_limit: int = 100` for quota tracking
   - If `api_key` is None/empty, log warning: "GNews API key not provided; source will return empty results"

2. **Async context manager** (`__aenter__` / `__aexit__`) mirroring GoogleNewsSource exactly.

3. **`_SUPPORTED_LANGUAGES` set** containing only the 8 confirmed GNews languages: `{"en", "hi", "bn", "ta", "te", "mr", "ml", "pa"}`. Per research: GNews does NOT support gu, kn, or, as, ur, ne.

4. **`search()` method** matching the Protocol signature exactly:
   - If no API key: return `[]`
   - If `language` not in `_SUPPORTED_LANGUAGES`: return `[]` (log at debug level: "GNews does not support language '%s', skipping")
   - If `_daily_count >= _daily_limit`: log debug "GNews daily limit reached" and return `[]`
   - Build URL: `https://gnews.io/api/v4/search` with params `{"apikey": key, "q": query, "lang": language, "country": country.lower(), "max": 10}`
   - Make GET request via `_ensure_client()`, timeout=self._timeout
   - Increment `_daily_count` after the request (before parsing)
   - Parse `articles` array from response JSON, map each to ArticleRef via `_gnews_to_ref()` helper
   - **Critical: HTTP 403 handling** -- GNews returns 403 when daily quota exhausted (NOT 429). On 403: set `_daily_count = _daily_limit` and log warning "GNews daily quota exhausted (HTTP 403)". Return `[]`.
   - HTTP 429: log warning "GNews per-second rate limit hit (HTTP 429)". Return `[]`.
   - HTTP 401: log error "Invalid GNews API key (HTTP 401)". Return `[]`.
   - Other HTTP errors: log warning with status code. Return `[]`.
   - Catch `httpx.TimeoutException`: log warning, return `[]`
   - Catch `httpx.RequestError`: log warning with error, return `[]`
   - Log info with query, language, articles parsed, entries skipped counts

5. **Module-level `_gnews_to_ref()` function**:
   - Extract `title` from `article.get("title")`, strip whitespace
   - Extract `url` from `article.get("url")`, strip whitespace (note: GNews uses `url`, not `link`)
   - Extract `published_at` from `article.get("publishedAt")`
   - Extract `source_name` from `article.get("source", {}).get("name", "Unknown")` (note: nested `source.name`)
   - If any of title, url, published_at is missing/empty: return None
   - Parse date: `datetime.fromisoformat(published_at.replace("Z", "+00:00"))` -- GNews always returns UTC ISO 8601 with trailing Z. Wrap in try/except for ValueError/TypeError/AttributeError.
   - Wrap ArticleRef construction in try/except, return None on failure
   - Parameters: `article: dict, language: str, state: str, search_term: str` -> `ArticleRef | None`

6. **`close()` and `_ensure_client()`** methods mirroring GoogleNewsSource exactly. Do NOT set `follow_redirects=True` (not needed for REST API).

Import only: `from __future__ import annotations`, `logging`, `datetime`/`timezone` from datetime, `httpx`, `ArticleRef` from `src.models.article`.
  </action>
  <verify>
Run: `python -c "from src.sources.gnews import GNewsSource; print('GNewsSource imported successfully')"` -- must print success message.
Run: `python -c "from src.sources._protocol import NewsSource; from src.sources.gnews import GNewsSource; print(isinstance(GNewsSource(api_key='test'), NewsSource))"` -- must print `True` (Protocol satisfaction).
Run: `python -c "import asyncio; from src.sources.gnews import GNewsSource; s = GNewsSource(); print(asyncio.run(s.search('test', 'en')))"` -- must print `[]` (no API key, returns empty).
Run: `python -c "import asyncio; from src.sources.gnews import GNewsSource; s = GNewsSource(api_key='test'); print(asyncio.run(s.search('test', 'gu')))"` -- must print `[]` (unsupported language, returns empty).
  </verify>
  <done>GNewsSource class exists in src/sources/gnews.py, imports successfully, satisfies NewsSource Protocol, returns empty list when no API key or unsupported language, and correctly filters for the 8 supported Indian languages.</done>
</task>

<task type="auto">
  <name>Task 2: Update package re-exports for all four source symbols</name>
  <files>src/sources/__init__.py</files>
  <action>
Update `src/sources/__init__.py` to add GNewsSource re-export. The file should now export all four symbols:

```python
from ._protocol import NewsSource
from .google_news import GoogleNewsSource
from .newsdata import NewsDataSource
from .gnews import GNewsSource

__all__ = ["NewsSource", "GoogleNewsSource", "NewsDataSource", "GNewsSource"]
```

Verify the full import chain works from the package level for all four symbols.
  </action>
  <verify>
Run: `python -c "from src.sources import NewsSource, GoogleNewsSource, NewsDataSource, GNewsSource; print('All four imported from src.sources')"` -- must print success.
Run: `python -c "from src.sources import GNewsSource; print(type(GNewsSource))"` -- must print `<class 'type'>`.
  </verify>
  <done>src.sources package exports all four symbols: NewsSource, GoogleNewsSource, NewsDataSource, GNewsSource.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.sources import GNewsSource; print('OK')"` -- import works
2. `python -c "from src.sources._protocol import NewsSource; from src.sources.gnews import GNewsSource; print(isinstance(GNewsSource(api_key='test'), NewsSource))"` -- Protocol satisfied
3. `python -c "import asyncio; from src.sources.gnews import GNewsSource; s = GNewsSource(); print(asyncio.run(s.search('heat wave', 'en')))"` -- no-key returns `[]`
4. `python -c "import asyncio; from src.sources.gnews import GNewsSource; s = GNewsSource(api_key='test'); s._daily_count = 100; print(asyncio.run(s.search('heat wave', 'en')))"` -- quota exhausted returns `[]`
5. `python -c "import asyncio; from src.sources.gnews import GNewsSource; s = GNewsSource(api_key='test'); print(asyncio.run(s.search('test', 'gu')))"` -- unsupported language returns `[]`
6. `python -c "from src.sources import NewsSource, GoogleNewsSource, NewsDataSource, GNewsSource; print('All sources available')"` -- full package export works
</verification>

<success_criteria>
- GNewsSource class satisfies NewsSource Protocol
- No API key -> returns empty list (no crash, no HTTP request)
- Unsupported language (gu, kn, or, as, ur, ne) -> returns empty list without HTTP request
- Daily quota tracking: after 100 requests, returns empty list immediately
- HTTP 403 (quota exhausted) correctly detected and stops further requests
- HTTP 429 (per-second rate limit) handled gracefully
- JSON response correctly mapped to ArticleRef objects with UTC->IST date conversion
- All four symbols importable from src.sources package
</success_criteria>

<output>
After completion, create `.planning/phases/05-secondary-news-sources/05-02-SUMMARY.md`
</output>
