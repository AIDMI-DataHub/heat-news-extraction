---
phase: 05-secondary-news-sources
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sources/newsdata.py
  - src/sources/__init__.py
autonomous: true
user_setup:
  - service: newsdata.io
    why: "Secondary news source for heat article collection"
    env_vars:
      - name: NEWSDATA_API_KEY
        source: "Sign up at https://newsdata.io/register -> Dashboard -> API Key"

must_haves:
  truths:
    - "NewsDataSource.search() returns list[ArticleRef] from NewsData.io API"
    - "When NEWSDATA_API_KEY is missing, NewsDataSource returns empty results without crashing"
    - "When daily quota (200 requests) is exhausted, search() returns empty list immediately without making HTTP request"
    - "HTTP errors (401, 403, 429, 5xx) and timeouts are caught and return empty list"
  artifacts:
    - path: "src/sources/newsdata.py"
      provides: "NewsDataSource class implementing NewsSource Protocol"
      contains: "class NewsDataSource"
    - path: "src/sources/__init__.py"
      provides: "Package re-export of NewsDataSource"
      contains: "NewsDataSource"
  key_links:
    - from: "src/sources/newsdata.py"
      to: "https://newsdata.io/api/1/latest"
      via: "httpx.AsyncClient.get() with apikey query param"
      pattern: "newsdata\\.io/api/1/latest"
    - from: "src/sources/newsdata.py"
      to: "src/models/article.py"
      via: "ArticleRef construction from JSON response"
      pattern: "ArticleRef\\("
---

<objective>
Implement the NewsData.io source adapter that satisfies the NewsSource Protocol and returns ArticleRef objects from the NewsData.io REST API.

Purpose: COLL-05 requires NewsData.io as a secondary news source (~200 queries/day). This adapter mirrors the existing GoogleNewsSource pattern but parses JSON instead of RSS.
Output: `src/sources/newsdata.py` with NewsDataSource class, updated `src/sources/__init__.py` with re-export.
</objective>

<execution_context>
@/Users/akashyadav/.claude/get-shit-done/workflows/execute-plan.md
@/Users/akashyadav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-secondary-news-sources/05-RESEARCH.md
@src/sources/_protocol.py
@src/sources/google_news.py
@src/sources/__init__.py
@src/models/article.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NewsDataSource adapter</name>
  <files>src/sources/newsdata.py</files>
  <action>
Create `src/sources/newsdata.py` implementing `NewsDataSource` that satisfies the `NewsSource` Protocol.

Mirror the `GoogleNewsSource` class structure exactly:

1. **Constructor** accepting `api_key: str | None = None`, `client: httpx.AsyncClient | None = None`, `timeout: float = 15.0`:
   - Store `_api_key`, `_client`, `_owns_client = client is None`, `_timeout`
   - Add `_daily_count: int = 0` and `_daily_limit: int = 200` for quota tracking
   - If `api_key` is None/empty, log warning: "NewsData.io API key not provided; source will return empty results"

2. **Async context manager** (`__aenter__` / `__aexit__`) mirroring GoogleNewsSource exactly.

3. **`_SUPPORTED_LANGUAGES` set** containing all 14 language codes: `{"en", "hi", "ta", "te", "bn", "mr", "gu", "kn", "ml", "or", "pa", "as", "ur", "ne"}`. Per research: NewsData.io claims 13 Indian languages and the API accepts standard ISO 639-1 codes.

4. **`search()` method** matching the Protocol signature exactly:
   - If no API key: return `[]`
   - If `language` not in `_SUPPORTED_LANGUAGES`: return `[]` (log at debug level)
   - If `_daily_count >= _daily_limit`: log debug "NewsData.io daily limit reached" and return `[]`
   - Build URL: `https://newsdata.io/api/1/latest` with params `{"apikey": key, "q": query, "language": language, "country": country.lower()}`
   - Make GET request via `_ensure_client()`, timeout=self._timeout
   - Increment `_daily_count` after the request (before parsing)
   - Check response JSON: if `status` field is `"error"`, log warning with error message and return `[]`
   - Parse `results` array from JSON, map each to ArticleRef via `_newsdata_to_ref()` helper
   - Catch `httpx.HTTPStatusError`: on 401 log error "Invalid API key"; on 403 set `_daily_count = _daily_limit` and log warning "quota exhausted"; on 429 log warning "rate limited"; else log warning with status code. All return `[]`.
   - Catch `httpx.TimeoutException`: log warning, return `[]`
   - Catch `httpx.RequestError`: log warning with error, return `[]`
   - Log info with query, language, articles parsed, entries skipped counts

5. **Module-level `_newsdata_to_ref()` function**:
   - Extract `title` from `article.get("title")`, strip whitespace
   - Extract `link` from `article.get("link")`, strip whitespace
   - Extract `pub_date_str` from `article.get("pubDate")`
   - Extract `source_name` from `article.get("source_name")` or `article.get("source_id")` or "Unknown"
   - If any of title, link, pub_date_str is missing/empty: return None
   - Parse date with `datetime.fromisoformat(pub_date_str)`. If naive (no tzinfo), assume UTC: `dt.replace(tzinfo=timezone.utc)`. ArticleRef validator will convert to IST.
   - Wrap ArticleRef construction in try/except, return None on failure
   - Parameters: `article: dict, language: str, state: str, search_term: str` -> `ArticleRef | None`

6. **`close()` and `_ensure_client()`** methods mirroring GoogleNewsSource exactly. Do NOT set `follow_redirects=True` on the client (not needed for REST API).

Import only: `from __future__ import annotations`, `logging`, `datetime`/`timezone` from datetime, `httpx`, `ArticleRef` from `src.models.article`.
  </action>
  <verify>
Run: `python -c "from src.sources.newsdata import NewsDataSource; print('NewsDataSource imported successfully')"` -- must print success message.
Run: `python -c "from src.sources._protocol import NewsSource; from src.sources.newsdata import NewsDataSource; print(isinstance(NewsDataSource(api_key='test'), NewsSource))"` -- must print `True` (Protocol satisfaction).
Run: `python -c "import asyncio; from src.sources.newsdata import NewsDataSource; s = NewsDataSource(); print(asyncio.run(s.search('test', 'en')))"` -- must print `[]` (no API key, returns empty).
  </verify>
  <done>NewsDataSource class exists in src/sources/newsdata.py, imports successfully, satisfies NewsSource Protocol, and returns empty list when no API key is configured.</done>
</task>

<task type="auto">
  <name>Task 2: Update package re-exports for NewsDataSource</name>
  <files>src/sources/__init__.py</files>
  <action>
Update `src/sources/__init__.py` to add NewsDataSource re-export:

1. Add import: `from .newsdata import NewsDataSource`
2. Add `"NewsDataSource"` to the `__all__` list

The file should have:
```python
from ._protocol import NewsSource
from .google_news import GoogleNewsSource
from .newsdata import NewsDataSource

__all__ = ["NewsSource", "GoogleNewsSource", "NewsDataSource"]
```

Verify the full import chain works from the package level.
  </action>
  <verify>
Run: `python -c "from src.sources import NewsSource, GoogleNewsSource, NewsDataSource; print('All three imported from src.sources')"` -- must print success.
Run: `python -c "from src.sources import NewsDataSource; print(type(NewsDataSource))"` -- must print `<class 'type'>`.
  </verify>
  <done>src.sources package exports NewsDataSource alongside NewsSource and GoogleNewsSource.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.sources import NewsDataSource; print('OK')"` -- import works
2. `python -c "from src.sources._protocol import NewsSource; from src.sources.newsdata import NewsDataSource; print(isinstance(NewsDataSource(api_key='test'), NewsSource))"` -- Protocol satisfied
3. `python -c "import asyncio; from src.sources.newsdata import NewsDataSource; s = NewsDataSource(); print(asyncio.run(s.search('heat wave', 'en')))"` -- no-key returns `[]`
4. `python -c "import asyncio; from src.sources.newsdata import NewsDataSource; s = NewsDataSource(api_key='test'); s._daily_count = 200; print(asyncio.run(s.search('heat wave', 'en')))"` -- quota exhausted returns `[]`
</verification>

<success_criteria>
- NewsDataSource class satisfies NewsSource Protocol
- No API key -> returns empty list (no crash, no HTTP request)
- Daily quota tracking: after 200 requests, returns empty list immediately
- HTTP errors (401, 403, 429, timeouts) caught and return empty list
- JSON response correctly mapped to ArticleRef objects
- Package-level import works: `from src.sources import NewsDataSource`
</success_criteria>

<output>
After completion, create `.planning/phases/05-secondary-news-sources/05-01-SUMMARY.md`
</output>
