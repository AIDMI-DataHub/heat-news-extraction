---
phase: 02-data-models-and-geographic-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/article.py
  - src/models/__init__.py
autonomous: true

must_haves:
  truths:
    - "An ArticleRef Pydantic model validates title, url, source, date, language, state, district, search_term with correct types"
    - "An Article Pydantic model extends ArticleRef with full_text and relevance_score fields"
    - "All dates are normalized to IST (Asia/Kolkata) timezone regardless of input timezone"
    - "Naive datetimes (no timezone) are assumed IST and accepted without error"
    - "Invalid data (empty title, out-of-range relevance_score, non-ISO date) is rejected by validation"
    - "Both models are frozen -- mutation raises an error"
  artifacts:
    - path: "src/models/article.py"
      provides: "ArticleRef and Article Pydantic v2 models with IST date validation"
      exports: ["ArticleRef", "Article", "IST"]
    - path: "src/models/__init__.py"
      provides: "Re-exports of ArticleRef and Article for clean imports"
      exports: ["ArticleRef", "Article"]
  key_links:
    - from: "src/models/article.py"
      to: "pydantic"
      via: "AwareDatetime, BaseModel, ConfigDict, Field, field_validator, BeforeValidator"
      pattern: "from pydantic import"
    - from: "src/models/article.py"
      to: "zoneinfo"
      via: "ZoneInfo('Asia/Kolkata') for IST"
      pattern: "ZoneInfo.*Asia/Kolkata"
    - from: "src/models/__init__.py"
      to: "src/models/article.py"
      via: "re-export ArticleRef, Article"
      pattern: "from .article import"
---

<objective>
Create the Pydantic v2 data models (ArticleRef and Article) that represent news articles throughout the pipeline lifecycle, with strict IST timezone validation on all dates.

Purpose: These models are the core data types used by every subsequent phase -- source adapters create ArticleRef instances, extraction enriches them into Article instances, and output serializes them.
Output: src/models/article.py with ArticleRef and Article models, updated src/models/__init__.py with re-exports.
</objective>

<execution_context>
@/Users/akashyadav/.claude/get-shit-done/workflows/execute-plan.md
@/Users/akashyadav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-models-and-geographic-data/02-RESEARCH.md
@src/models/__init__.py
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ArticleRef and Article Pydantic models with IST date validation</name>
  <files>src/models/article.py</files>
  <action>
Create `src/models/article.py` with the following implementation:

**Constants:**
- `IST = ZoneInfo("Asia/Kolkata")` -- module-level constant for IST timezone

**Helper:**
- `coerce_naive_to_ist(value: Any) -> Any` -- a BeforeValidator function that checks if a datetime has no tzinfo; if so, replaces tzinfo with IST. If the value is a string or already timezone-aware, passes through unchanged. This handles edge cases where news sources return naive datetimes.
- Define `ISTAwareDatetime = Annotated[AwareDatetime, BeforeValidator(coerce_naive_to_ist)]` as a reusable type alias.

**ArticleRef model (lightweight search result):**
- `model_config = ConfigDict(frozen=True)` -- immutable
- Fields:
  - `title: str` -- Field(..., min_length=1, max_length=500)
  - `url: str` -- Field(..., min_length=1). Use `str`, not `HttpUrl` (some Google News URLs have unusual schemes).
  - `source: str` -- Field(..., min_length=1). The news source name (e.g., "The Hindu", "NDTV").
  - `date: ISTAwareDatetime` -- Publication date. Uses the custom ISTAwareDatetime type.
  - `language: str` -- Field(..., pattern=r"^(en|hi|ta|te|bn|mr|gu|kn|ml|or|pa|as|ur|ne)$"). Constrained to the 14 supported language codes.
  - `state: str` -- Field(..., min_length=1). State/UT slug (e.g., "tamil-nadu").
  - `district: str | None = None` -- Optional district slug.
  - `search_term: str` -- Field(..., min_length=1). The search query that found this article.
- Add `field_validator("date")` with `@classmethod` that calls `v.astimezone(IST)` to normalize any timezone-aware datetime to IST.

**Article model (complete article with extraction results):**
- Inherits from `ArticleRef`. Same frozen config is inherited.
- Additional fields:
  - `full_text: str | None = None` -- Extracted article body text. None until Phase 7 extraction.
  - `relevance_score: float = Field(default=0.0, ge=0.0, le=1.0)` -- 0.0 to 1.0 relevance score. Set during Phase 8 filtering.

**Imports needed:**
- `from __future__ import annotations`
- `from datetime import datetime`
- `from typing import Annotated, Any`
- `from zoneinfo import ZoneInfo`
- `from pydantic import AwareDatetime, BaseModel, BeforeValidator, ConfigDict, Field, field_validator`

Do NOT use pytz. Use zoneinfo (stdlib). Do NOT use Pydantic v1 patterns (no `class Config:`, no `validator` decorator, no `.dict()`).
  </action>
  <verify>
Run: `python -c "
from src.models.article import ArticleRef, Article, IST
from datetime import datetime, timezone
from zoneinfo import ZoneInfo

# Test 1: Valid ArticleRef with UTC date (should normalize to IST)
ref = ArticleRef(
    title='Heat wave kills 10 in Bihar',
    url='https://example.com/article/1',
    source='The Hindu',
    date=datetime(2026, 5, 15, 10, 0, 0, tzinfo=timezone.utc),
    language='en',
    state='bihar',
    search_term='heat wave Bihar'
)
assert str(ref.date.tzinfo) == 'Asia/Kolkata', f'Expected IST, got {ref.date.tzinfo}'
assert ref.date.hour == 15  # UTC 10:00 -> IST 15:30
assert ref.date.minute == 30
print('PASS: UTC date normalized to IST')

# Test 2: Naive datetime should be accepted (assumed IST)
ref2 = ArticleRef(
    title='Water crisis in Chennai',
    url='https://example.com/2',
    source='NDTV',
    date=datetime(2026, 5, 15, 14, 0, 0),  # naive
    language='ta',
    state='tamil-nadu',
    search_term='water crisis Chennai'
)
assert str(ref2.date.tzinfo) == 'Asia/Kolkata'
print('PASS: Naive datetime accepted as IST')

# Test 3: Article extends ArticleRef
art = Article(
    title='Heat stroke deaths rise',
    url='https://example.com/3',
    source='TOI',
    date=datetime(2026, 5, 15, 10, 0, 0, tzinfo=timezone.utc),
    language='hi',
    state='uttar-pradesh',
    search_term='heat stroke UP',
    full_text='Full article body here...',
    relevance_score=0.85
)
assert art.full_text == 'Full article body here...'
assert art.relevance_score == 0.85
print('PASS: Article model with full_text and relevance_score')

# Test 4: Frozen model
try:
    ref.title = 'Changed'
    print('FAIL: Should have raised error for frozen model')
except Exception:
    print('PASS: Frozen model rejects mutation')

# Test 5: Invalid language code rejected
try:
    ArticleRef(
        title='Test', url='https://x.com', source='X',
        date=datetime(2026, 5, 15, 10, 0, 0, tzinfo=timezone.utc),
        language='xx', state='delhi', search_term='test'
    )
    print('FAIL: Should have rejected invalid language code')
except Exception:
    print('PASS: Invalid language code rejected')

# Test 6: Relevance score out of range rejected
try:
    Article(
        title='Test', url='https://x.com', source='X',
        date=datetime(2026, 5, 15, 10, 0, 0, tzinfo=timezone.utc),
        language='en', state='delhi', search_term='test',
        relevance_score=1.5
    )
    print('FAIL: Should have rejected out-of-range score')
except Exception:
    print('PASS: Out-of-range relevance_score rejected')

print('All tests passed.')
"
  </verify>
  <done>ArticleRef and Article models exist in src/models/article.py. UTC dates normalize to IST. Naive datetimes are accepted as IST. Frozen models reject mutation. Invalid language codes and out-of-range scores are rejected.</done>
</task>

<task type="auto">
  <name>Task 2: Update models __init__.py to re-export article models</name>
  <files>src/models/__init__.py</files>
  <action>
Update `src/models/__init__.py` to re-export the article models for clean imports:

```python
"""Pydantic data models for the heat news extraction pipeline."""

from .article import Article, ArticleRef, IST

__all__ = ["Article", "ArticleRef", "IST"]
```

This allows downstream code to use `from src.models import Article, ArticleRef` instead of `from src.models.article import ...`.

Also verify the full import chain still works by running `python main.py` to ensure no regressions from Phase 1.
  </action>
  <verify>
Run: `python -c "from src.models import Article, ArticleRef, IST; print(f'ArticleRef fields: {list(ArticleRef.model_fields.keys())}'); print(f'Article fields: {list(Article.model_fields.keys())}'); print(f'IST: {IST}')"` -- should print field names and IST timezone.

Then run: `python main.py` -- should still exit cleanly with no errors (Phase 1 regression check).
  </verify>
  <done>src/models/__init__.py re-exports Article, ArticleRef, and IST. Both `from src.models import Article` and `python main.py` work without errors.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.models import ArticleRef, Article"` imports without error
2. Creating an ArticleRef with a UTC datetime produces an IST-normalized date
3. Creating an ArticleRef with a naive datetime succeeds (treated as IST)
4. Creating an ArticleRef with an invalid language code raises ValidationError
5. Article inherits all ArticleRef fields and adds full_text + relevance_score
6. Both models are frozen (assignment raises error)
7. `python main.py` still runs cleanly (no Phase 1 regression)
</verification>

<success_criteria>
- ArticleRef and Article Pydantic v2 models exist with all DATA-01/DATA-02/DATA-03 required fields
- Date validation enforces IST timezone (DATA-03) via normalization, not rejection
- Naive datetimes are accepted with IST assumption (BeforeValidator)
- Models are frozen and immutable
- Language field constrained to the 14 supported codes
- Clean imports work via src/models/__init__.py
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-models-and-geographic-data/02-01-SUMMARY.md`
</output>
